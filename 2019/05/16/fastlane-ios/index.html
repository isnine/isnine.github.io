<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="做什么都是因为喜欢.">
    <meta name="keyword" content="">
    <meta name="theme-color" content="#600090">
    <meta name="msapplication-navbutton-color" content="#600090">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="#600090">
    <link rel="shortcut icon" href="favicon1.png">
    <link rel="alternate" type="application/atom+xml" title="Nine" href="/atom.xml">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.css">
    <title>
        
        iOS Fastlane+CI自动化构建｜Nine&#39;s Blog
        
    </title>

    <link rel="canonical" href="https://www.wxz.name/2019/05/16/fastlane-ios/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/blog-style.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
</head>

<style>

    header.intro-header {
        background-image: url('https://oco8bvfr8.qnssl.com/lion-blur-bg.jpg')
    }
</style>
<!-- hack iOS CSS :active style -->
<body ontouchstart="" class="animated fadeIn">
<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top " id="nav-top" data-ispost = "true" data-istags="false
" data-ishome = "false" >
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand animated pulse" href="/">
                <span class="brand-logo">
                    Nine
                </span>
                's Blog
            </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <!-- /.navbar-collapse -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
					
                    
                        
							
                        <li>
                            <a href="/about/">About</a>
                        </li>
							
						
                    
                        
							
                        <li>
                            <a href="/work/">work</a>
                        </li>
							
						
                    
                        
							
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
							
						
                    
					
					
                </ul>
            </div>
        </div>
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
//    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>

<!-- Main Content -->

<!--only post-->


<img class="wechat-title-img"
     src="https://img.wxz.name/post-default.jpg">


<style>
    
    header.intro-header {
        background-image: url('https://img.wxz.name/post-default.jpg')
    }

    
</style>

<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <div class="post-heading">
                    <h1>iOS Fastlane+CI自动化构建</h1>
                    
                    <span class="meta">
                         作者 汪小祯
                        <span>
                          日期 2019-05-16
                         </span>
                    </span>
                    <div class="tags text-center">
                        
                        <a class="tag" href="/tags/#iOS"
                           title="iOS">iOS</a>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="post-title-haojen">
        <span>
            iOS Fastlane+CI自动化构建
        </span>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Container -->
            <div class="col-lg-8 col-lg-offset-1 col-sm-9 post-container">
                <h1 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h1><p>在公司时，都是由一套完整的工具链完成，开发-&gt;构建-&gt;分发-&gt;测试，等流程<br>而作为个人开发时，失去了这套工具链，自然感觉到十分不便<br>所以笔者思考，能否自己搭建一套这样的工具链呢</p>
<h1 id="需求列表"><a href="#需求列表" class="headerlink" title="需求列表"></a>需求列表</h1><p>搭建一套工具，首先要明确我想实现的效果<br>我目前发布一个版本到TestFlight内测，需要以下几个步骤</p>
<ul>
<li>手动改Xcode的build号格式为当天日期+次数，如09051601</li>
<li>手动archive，等待漫长过程，然后上传appstore</li>
<li>等待30分钟左右机器审核，然后手动选择组</li>
<li>重复输入更新内容，再点分发测试</li>
</ul>
<p>如果需要发一个版本到AppStore<br>除了上述几个内容，我还需要</p>
<ul>
<li>选择编译版本</li>
<li>添加版本更新内容</li>
<li>选择有无加密app</li>
<li>有无增加广告标识号</li>
</ul>
<p>对于我而说，我希望上述两个过程，全部可以分别通过一行命令来进行<br>我希望我只需要<strong>git push</strong>一下，这些操作会自动在背后ci构建</p>
<h1 id="最终实现效果"><a href="#最终实现效果" class="headerlink" title="最终实现效果"></a>最终实现效果</h1><p>本地git push后</p>
<ul>
<li>如果当前在master分支，ci自动打包发布TestFlight，版本号为当前日期+次数，并打tag提交。</li>
<li>如果当前在release/xxx分支，ci自动发布AppStore，版本号为当前日期+次数，并打tag提交。<h2 id="流程示意图"><a href="#流程示意图" class="headerlink" title="流程示意图"></a>流程示意图</h2><img src="https://img.wxz.name/15583584051012.jpg" alt=""><h2 id="Ci结果图"><a href="#Ci结果图" class="headerlink" title="Ci结果图"></a>Ci结果图</h2><img src="https://img.wxz.name/15583584946186.jpg" alt=""></li>
</ul>
<h1 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h1><h2 id="选用工具"><a href="#选用工具" class="headerlink" title="选用工具"></a>选用工具</h2><ul>
<li>github作为存储代码的仓库</li>
<li>travis-ci作为构建的ci</li>
<li>fastlane作为构建工具<blockquote>
<p>注意，如果你的仓库是私有仓库的话，travis-ci将不再免费，不过如果通过了学生认证的话，依旧是免费的，笔者因为目前是学生，所以并没有单独购买。</p>
</blockquote>
</li>
</ul>
<h2 id="期间遇到的坑"><a href="#期间遇到的坑" class="headerlink" title="期间遇到的坑"></a>期间遇到的坑</h2><ul>
<li>travis-ci 的KeyChain导致不能编译</li>
<li>apple的两步验证导致流程不能通过</li>
<li>build号自增</li>
</ul>
<h2 id="1-配置Fastlane"><a href="#1-配置Fastlane" class="headerlink" title="1.配置Fastlane"></a>1.配置Fastlane</h2><p>首先进入工程目录，安装并对工程目录初始化<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># 安装fastlane</div><div class="line">sudo gem install fastlane -NV</div><div class="line"># 初始化工程</div><div class="line">fastlane init</div></pre></td></tr></table></figure></p>
<p>接着修改Fastfile文件<br>可以参照我的<a href="https://gist.github.com/isnine/d4aacf8fcc7ecae50c3c8390651b893f" target="_blank" rel="external">Fastfile文件</a></p>
<h2 id="1-1-更新版本号配置"><a href="#1-1-更新版本号配置" class="headerlink" title="1.1 更新版本号配置"></a>1.1 更新版本号配置</h2><p>在这一步中，我会先从iTunes Connect上获取最新的版本号，然后拉取下来，如果日期相同，则加一，否则重置为当天日期+01.比如19055101<br><figure class="highlight ruby"><table><tr><td class="code"><pre><div class="line">    <span class="comment"># 更新版本号</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">updateProjectBuildNumber</span></span></div><div class="line">   currentTime = Time.new.strftime(<span class="string">"%y%m%d"</span>)</div><div class="line">   build = latest_testflight_build_number(<span class="symbol">version:</span> get_version_number)</div><div class="line">   puts(<span class="string">"*************| Tag: <span class="subst">#&#123;build&#125;</span> |*************"</span>)</div><div class="line">   buildStr = build.to_s</div><div class="line">   <span class="keyword">if</span> buildStr.<span class="keyword">include</span>?<span class="string">"<span class="subst">#&#123;currentTime&#125;</span>"</span></div><div class="line">      <span class="comment"># =&gt; 为当天版本 计算迭代版本号</span></div><div class="line">      lastStr = buildStr[buildStr.length-<span class="number">2</span>..buildStr.length-<span class="number">1</span>]</div><div class="line">      lastNum = lastStr.to_i</div><div class="line">      lastNum = lastNum + <span class="number">1</span></div><div class="line">      lastStr = lastNum.to_s</div><div class="line">      <span class="keyword">if</span> lastNum &lt; <span class="number">10</span></div><div class="line">         lastStr = lastStr.insert(<span class="number">0</span>,<span class="string">"0"</span>)</div><div class="line">      <span class="keyword">end</span></div><div class="line">      build = <span class="string">"<span class="subst">#&#123;currentTime&#125;</span><span class="subst">#&#123;lastStr&#125;</span>"</span></div><div class="line">   <span class="keyword">else</span></div><div class="line">      <span class="comment"># =&gt; 非当天版本 build 号重置</span></div><div class="line">      build = <span class="string">"<span class="subst">#&#123;currentTime&#125;</span>01"</span></div><div class="line">   <span class="keyword">end</span></div><div class="line">   puts(<span class="string">"*************| 更新build <span class="subst">#&#123;build&#125;</span> |*************"</span>)</div><div class="line">   <span class="comment"># =&gt; 更改项目 build 号</span></div><div class="line">   increment_build_number(</div><div class="line">   <span class="symbol">build_number:</span> <span class="string">"<span class="subst">#&#123;build&#125;</span>"</span></div><div class="line">   )</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<h2 id="1-3-上传testFlight配置"><a href="#1-3-上传testFlight配置" class="headerlink" title="1.3 上传testFlight配置"></a>1.3 上传testFlight配置</h2><p>在这一部中，我会首先编译当前的app，然后上传到testFlight,最后更新版本tag，push到远端，再上传dysm到fabric中。Changelog.txt里会存放我这个版本的变更内容。<br><figure class="highlight ruby"><table><tr><td class="code"><pre><div class="line">platform <span class="symbol">:ios</span> <span class="keyword">do</span></div><div class="line">   lane <span class="symbol">:beta</span> <span class="keyword">do</span></div><div class="line">      <span class="comment"># 编译app</span></div><div class="line">      buildApp</div><div class="line">      <span class="comment"># 上传</span></div><div class="line">      upload_to_testflight(</div><div class="line">      <span class="symbol">beta_app_feedback_email:</span> <span class="string">"wxz@wxz.name"</span>,</div><div class="line">      <span class="symbol">beta_app_description:</span> <span class="string">""</span>,</div><div class="line">      <span class="symbol">notify_external_testers:</span> <span class="literal">false</span>,</div><div class="line">      <span class="symbol">distribute_external:</span> <span class="literal">true</span>,</div><div class="line">      <span class="symbol">changelog:</span> File.read(<span class="string">"Changelog.txt"</span>),</div><div class="line">      <span class="symbol">groups:</span> [<span class="string">"testflight.top"</span>,<span class="string">"Price Tag"</span>,<span class="string">"其他渠道"</span>],</div><div class="line">      )</div><div class="line">      <span class="comment"># 更新版本tag</span></div><div class="line">      add_git_tag</div><div class="line">      <span class="keyword">if</span> is_ci?</div><div class="line">        system <span class="string">"git push https://isnine:$&#123;GH_Token&#125;@github.com/user/repo.git --tags"</span></div><div class="line">     <span class="keyword">else</span></div><div class="line">        push_to_git_remote</div><div class="line">     <span class="keyword">end</span></div><div class="line">      <span class="comment"># 上传dysm</span></div><div class="line">      <span class="comment"># crashlytics(api_token: "xxxxx",</span></div><div class="line">      <span class="comment"># build_secret: "xxxx")</span></div><div class="line">   <span class="keyword">end</span></div><div class="line">   <span class="comment"># 编译当前app</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">buildApp</span></span></div><div class="line">   <span class="comment"># 更改build号</span></div><div class="line">   updateProjectBuildNumber</div><div class="line">   <span class="comment"># 编译</span></div><div class="line">   build_app(<span class="symbol">workspace:</span> <span class="string">"easy.xcworkspace"</span>, <span class="symbol">scheme:</span> <span class="string">"easy"</span>)</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<h2 id="1-4-上传appStore配置"><a href="#1-4-上传appStore配置" class="headerlink" title="1.4 上传appStore配置"></a>1.4 上传appStore配置</h2><p>这一步和上一步也类似，只是apple store的选项比较多<br><figure class="highlight ruby"><table><tr><td class="code"><pre><div class="line">platform <span class="symbol">:ios</span> <span class="keyword">do</span></div><div class="line">   lane <span class="symbol">:release</span> <span class="keyword">do</span></div><div class="line">      <span class="comment"># 编译app</span></div><div class="line">      buildApp</div><div class="line">      <span class="comment"># 上传app</span></div><div class="line">      upload_to_app_store(</div><div class="line">      <span class="symbol">skip_screenshots:</span> <span class="literal">true</span>,</div><div class="line">      <span class="symbol">skip_metadata:</span> <span class="literal">false</span>,</div><div class="line">      <span class="symbol">reject_if_possible:</span> <span class="literal">true</span>,</div><div class="line">      <span class="comment"># skip_binary_upload: true,</span></div><div class="line">      <span class="symbol">force:</span> <span class="literal">true</span>,</div><div class="line">      <span class="symbol">app_review_information:</span> &#123;</div><div class="line">         <span class="symbol">first_name:</span> <span class="string">'W'</span>,</div><div class="line">         <span class="symbol">last_name:</span> <span class="string">'XZ'</span>,</div><div class="line">         <span class="symbol">phone_number:</span> <span class="string">'+86 1760000000'</span>,</div><div class="line">         <span class="symbol">email_address:</span> <span class="string">'user@example.com'</span>,</div><div class="line">         <span class="symbol">demo_user:</span> <span class="string">''</span>,</div><div class="line">         <span class="symbol">demo_password:</span> <span class="string">''</span>,</div><div class="line">         <span class="symbol">notes:</span> <span class="string">''</span></div><div class="line">      &#125;,</div><div class="line">      <span class="symbol">submit_for_review:</span> <span class="literal">true</span>,</div><div class="line">      <span class="symbol">submission_information:</span> &#123;</div><div class="line">         <span class="symbol">add_id_info_limits_tracking:</span> <span class="literal">true</span>,</div><div class="line">         <span class="symbol">add_id_info_serves_ads:</span> <span class="literal">false</span>,</div><div class="line">         <span class="symbol">add_id_info_tracks_action:</span> <span class="literal">true</span>,</div><div class="line">         <span class="symbol">add_id_info_tracks_install:</span> <span class="literal">true</span>,</div><div class="line">         <span class="symbol">add_id_info_uses_idfa:</span> <span class="literal">true</span>,</div><div class="line">         <span class="symbol">content_rights_has_rights:</span> <span class="literal">true</span>,</div><div class="line">         <span class="symbol">content_rights_contains_third_party_content:</span> <span class="literal">true</span>,</div><div class="line">         <span class="symbol">export_compliance_platform:</span> <span class="string">'ios'</span>,</div><div class="line">         <span class="symbol">export_compliance_compliance_required:</span> <span class="literal">false</span>,</div><div class="line">         <span class="symbol">export_compliance_encryption_updated:</span> <span class="literal">false</span>,</div><div class="line">         <span class="symbol">export_compliance_app_type:</span> <span class="literal">nil</span>,</div><div class="line">         <span class="symbol">export_compliance_uses_encryption:</span> <span class="literal">false</span>,</div><div class="line">         <span class="symbol">export_compliance_is_exempt:</span> <span class="literal">false</span>,</div><div class="line">         <span class="symbol">export_compliance_contains_third_party_cryptography:</span> <span class="literal">false</span>,</div><div class="line">         <span class="symbol">export_compliance_contains_proprietary_cryptography:</span> <span class="literal">false</span>,</div><div class="line">         <span class="symbol">export_compliance_available_on_french_store:</span> <span class="literal">false</span></div><div class="line">      &#125;,</div><div class="line">      <span class="symbol">release_notes:</span> &#123;<span class="string">'default'</span> =&gt; File.read(<span class="string">"Changelog.txt"</span>),</div><div class="line">                      <span class="string">'zh-Hans'</span> =&gt; File.read(<span class="string">"Changelog.txt"</span>),</div><div class="line">                      <span class="string">'en-US'</span> =&gt; File.read(<span class="string">"Changelog.txt"</span>)&#125;</div><div class="line">      )</div><div class="line">      <span class="comment"># 更新版本tag</span></div><div class="line">      add_git_tag</div><div class="line">      <span class="keyword">if</span> is_ci?</div><div class="line">        system <span class="string">"git push https://isnine:$&#123;GH_Token&#125;@github.com/user/repo.git --tags"</span></div><div class="line">     <span class="keyword">else</span></div><div class="line">        push_to_git_remote</div><div class="line">     <span class="keyword">end</span></div><div class="line">      <span class="comment"># 上传dysm</span></div><div class="line">      <span class="comment"># crashlytics(api_token: "xxxx",</span></div><div class="line">      <span class="comment"># build_secret: "xxx")</span></div><div class="line">   <span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<h2 id="2-ci配置"><a href="#2-ci配置" class="headerlink" title="2 ci配置"></a>2 ci配置</h2><p>完成了上面两步，其实已经可以通过fastlane beta和fastlanbe release在本地发布了，因为本地非常方面，其实是不需要考虑以下问题。</p>
<ul>
<li>证书导入</li>
<li>私钥导入</li>
<li>github push权限</li>
<li>apple connect权限</li>
<li>两步认证<br>而CI因为每次启动都是一个新的环境，这些全部要考虑一遍。<br>首先需要再fastlane/certs/目录下存放好相关的p12和描述文件,如图所示:<br><img src="https://img.wxz.name/15584097255132.jpg" alt=""><br>接着我在fastlane目录下，写了个导入描述文件的脚本:<br>load_provision.sh<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles</div><div class="line">cp ./certs/*.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/</div></pre></td></tr></table></figure>
</li>
</ul>
<p>最后Fastfile部分如下<br><figure class="highlight ruby"><table><tr><td class="code"><pre><div class="line"><span class="comment"># 记得提前在CI中设置 https://travis-ci.com/&#123;user&#125;/&#123;app&#125;/settings</span></div><div class="line">  <span class="comment"># - GH_Token //Github的token</span></div><div class="line">  <span class="comment"># - Cert_PassWord //证书密码</span></div><div class="line">  <span class="comment"># - FASTLANE_PASSWORD // Apple 账号密码</span></div><div class="line">  <span class="comment"># - FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD //不开两步认证忽略，PassWord apple专用密码</span></div><div class="line">  <span class="comment"># - Apple_Session //appleSession，不开两步认证忽略，通过fastlane spaceauth -u user<span class="doctag">@example</span>.com获得</span></div><div class="line">  lane <span class="symbol">:ci</span> <span class="keyword">do</span></div><div class="line">     branch = git_branch</div><div class="line">     puts(<span class="string">"*************| 当前branch <span class="subst">#&#123;branch&#125;</span> |*************"</span>)</div><div class="line">     <span class="comment"># 配置环境</span></div><div class="line">     keychain_name = <span class="string">"easy-build"</span></div><div class="line">     keychain_password = <span class="string">"travis"</span></div><div class="line">     <span class="comment"># 设置session 规避两步验证码，不开两步认证忽略</span></div><div class="line">     <span class="comment"># ENV["FASTLANE_SESSION"] = File.read("session.txt")</span></div><div class="line">     <span class="comment"># 创建临时钥匙串</span></div><div class="line">     create_keychain(</div><div class="line">     <span class="symbol">name:</span> keychain_name,</div><div class="line">     <span class="symbol">password:</span> keychain_password,</div><div class="line">     <span class="symbol">default_keychain:</span> <span class="literal">true</span>,</div><div class="line">     <span class="symbol">unlock:</span> <span class="literal">true</span>,</div><div class="line">     <span class="symbol">timeout:</span> <span class="number">3600</span>,</div><div class="line">     <span class="symbol">add_to_search_list:</span> <span class="literal">true</span></div><div class="line">     )</div><div class="line">     <span class="comment"># 导入私钥</span></div><div class="line">     import_certificate(</div><div class="line">     <span class="symbol">certificate_path:</span> <span class="string">"./fastlane/certs/dist.p12"</span>,</div><div class="line">     <span class="symbol">certificate_password:</span> ENV[<span class="string">"Cert_PassWord"</span>],</div><div class="line">     <span class="symbol">keychain_name:</span> keychain_name,</div><div class="line">     <span class="symbol">keychain_password:</span> keychain_password</div><div class="line">     )</div><div class="line">     import_certificate(</div><div class="line">     <span class="symbol">certificate_path:</span> <span class="string">"./fastlane/certs/dev.p12"</span>,</div><div class="line">     <span class="symbol">certificate_password:</span> ENV[<span class="string">"Cert_PassWord"</span>],</div><div class="line">     <span class="symbol">keychain_name:</span> keychain_name,</div><div class="line">     <span class="symbol">keychain_password:</span> keychain_password</div><div class="line">     )</div><div class="line">     <span class="comment"># 拉取证书</span></div><div class="line">     system <span class="string">"sh ./load_provision.sh"</span></div><div class="line">     <span class="comment"># sigh(app_identifier: "bundle.id",</span></div><div class="line">     <span class="comment">#   username: "user<span class="doctag">@exampe</span>.com")</span></div><div class="line">     <span class="keyword">if</span> branch.start_with? <span class="string">"master"</span></div><div class="line">        beta</div><div class="line">     <span class="keyword">elsif</span> branch.start_with? <span class="string">"release"</span></div><div class="line">        release</div><div class="line">     <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<h2 id="2-1-Travis-ci配置"><a href="#2-1-Travis-ci配置" class="headerlink" title="2.1 Travis-ci配置"></a>2.1 Travis-ci配置</h2><blockquote>
<p>这部分我以新开一个开发者账号的方式讲，我强烈推荐这种方式。<br>你可以在后文中找到，如果不开新账号，用原来带有两步认证的开发者账号怎么实现。</p>
</blockquote>
<p>这里我们一共需要配置四个环境变量</p>
<ul>
<li>GH_Token //Github的token</li>
<li>Cert_PassWord //证书密码</li>
<li>FASTLANE_USER // Apple 账号</li>
<li>FASTLANE_PASSWORD // Apple 账号密码<br><img src="https://img.wxz.name/15584100323855.jpg" alt=""><h3 id="GH-Token"><a href="#GH-Token" class="headerlink" title="GH_Token"></a>GH_Token</h3>这一步是为了解决push权限的问题<br><img src="https://img.wxz.name/15584101532733.jpg" alt=""><br><img src="https://img.wxz.name/15584101656036.jpg" alt=""><br>然后将创建的token复制过来作为GH_Token的值即可<blockquote>
<p>记得前面Fastfile里面的仓库地址也要改</p>
</blockquote>
<h3 id="FASTLANE-USER和FASTLANE-PASSWORD"><a href="#FASTLANE-USER和FASTLANE-PASSWORD" class="headerlink" title="FASTLANE_USER和FASTLANE_PASSWORD"></a>FASTLANE_USER和FASTLANE_PASSWORD</h3><a href="https://appstoreconnect.apple.com/" target="_blank" rel="external">https://appstoreconnect.apple.com/</a><br>这个很好理解，你的apple账号和密码。我踩了无数坑了，强烈建议重新创一个没有两步认证的apple小号。<br>然后在大号中邀请进来.<br>个人开发者账号虽然邀请进来的人不能拉取证书，但是一样有权限发布上传App<br><img src="https://img.wxz.name/15584105581907.jpg" alt=""><br>接着在ci中把FASTLANE_USER和FASTLANE_PASSWORD这两项配置好</li>
</ul>
<h3 id="Cert-PassWord"><a href="#Cert-PassWord" class="headerlink" title="Cert_PassWord"></a>Cert_PassWord</h3><p>我们在keychain中，导出时设置的p12文件的密码，就是这一项<br><img src="https://img.wxz.name/15584106259902.jpg" alt=""></p>
<h1 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h1><h2 id="1-为什么不直接用带有两步认证的账号"><a href="#1-为什么不直接用带有两步认证的账号" class="headerlink" title="1.为什么不直接用带有两步认证的账号"></a>1.为什么不直接用带有两步认证的账号</h2><p>如果用带两步认证的账号，需要配置apple专用密码，并且还要加上session。<br>而session特别容易过期，网上说是30天，笔者测试下来一天就要重新设置一次，十分痛苦<br>如果一定要用的话，可以在刚刚的流程结束完，在ci中设置一个新的环境变量<br>FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD<br>可以在这里面设置<a href="https://appleid.apple.com/account/manage" target="_blank" rel="external">https://appleid.apple.com/account/manage</a><br><img src="https://img.wxz.name/15584109865524.jpg" alt=""><br>同时因为登录会话的问题，如果想在ci上直接绕过两步认证，还需要配置好session<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">fastlane spaceauth -u user@example.com #你的apple账号</div></pre></td></tr></table></figure></p>
<p>然后复制session，我这里是在fastlane文件夹下创建了一个session.txt<br>将内容复制到里面去。<br>在脚本中再通过代码设置出来<br><figure class="highlight ruby"><table><tr><td class="code"><pre><div class="line">ENV[<span class="string">"FASTLANE_SESSION"</span>] = File.read(<span class="string">"session.txt"</span>)</div></pre></td></tr></table></figure></p>

                <hr>
                

                <ul class="pager">
                    
                    
                    <li class="next">
                        <a href="/2019/04/06/Swinject-source/" data-toggle="tooltip" data-placement="top"
                           title="Swinject源码解析">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                

                


                <!--加入新的评论系统-->
                

                <!--加入新的评论系统-->
               
                    <div class="comments">
                    <div id="container"></div>
                        <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
                        <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
                         <script>
                            var gitment = new Gitment({
                            id: location.pathname, // 可选。默认为 location.href
                            owner: "isnine",
                            repo: "www.wxz.name",
                            oauth: {
                            client_id: "e3bfc43b9dfc0410745c",
                            client_secret: "ee11e9819591ef72c8584abd8d5e1e21fbaf6cc4",
                            },
                            })
                        gitment.render('container')
                        </script>
                </div>
                
                
            </div>

            <div class="hidden-xs col-sm-3 toc-col">
                <div class="toc-wrap">
                    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#摘要"><span class="toc-text">摘要</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#需求列表"><span class="toc-text">需求列表</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#最终实现效果"><span class="toc-text">最终实现效果</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#流程示意图"><span class="toc-text">流程示意图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ci结果图"><span class="toc-text">Ci结果图</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实现步骤"><span class="toc-text">实现步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#选用工具"><span class="toc-text">选用工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#期间遇到的坑"><span class="toc-text">期间遇到的坑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-配置Fastlane"><span class="toc-text">1.配置Fastlane</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-更新版本号配置"><span class="toc-text">1.1 更新版本号配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-上传testFlight配置"><span class="toc-text">1.3 上传testFlight配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-上传appStore配置"><span class="toc-text">1.4 上传appStore配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-ci配置"><span class="toc-text">2 ci配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-Travis-ci配置"><span class="toc-text">2.1 Travis-ci配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GH-Token"><span class="toc-text">GH_Token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FASTLANE-USER和FASTLANE-PASSWORD"><span class="toc-text">FASTLANE_USER和FASTLANE_PASSWORD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cert-PassWord"><span class="toc-text">Cert_PassWord</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#踩过的坑"><span class="toc-text">踩过的坑</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-为什么不直接用带有两步认证的账号"><span class="toc-text">1.为什么不直接用带有两步认证的账号</span></a></li></ol></li></ol>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5 class="text-center">
                        <a href="/tags/">FEATURED TAGS</a>
                    </h5>
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#iOS"
                           title="iOS">iOS</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <div style="margin-top: 20px;">
                    <h5 class="text-center">FRIENDS</h5>
                    <ul class="list-inline text-center">
                        
                        <li><a href="http://www.zengheng.top/">曾恒</a></li>
                        
                        <li><a href="http://gunpowder.net.cn/">火药</a></li>
                        
                        <li><a href="https://CSeventh.github.io">昌强</a></li>
                        
                        <li><a href="https://royalq.github.io">邱雄强</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>

    </div>
</article>







<!-- Footer -->
<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <br>
                <ul class="list-inline text-center">
                
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/isnine">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/isnine">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Nine 2019
                    <br>
                    <span id="busuanzi_container_site_pv" style="font-size: 12px;">PV: <span id="busuanzi_value_site_pv"></span> Times</span>
                    <br>
                    Theme by <a href="https://haojen.github.io/">Haojen Ma</a>
                </p>

            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/blog.js"></script>

<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://www.wxz.name/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>

<!-- Google Analytics -->



<!-- Baidu Tongji -->


<!-- swiftype -->
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','','2.0.0');
</script>

<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!--wechat title img-->
<img class="wechat-title-img" src="https://img.wxz.name/psb-7.jpeg">
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>

</html>
